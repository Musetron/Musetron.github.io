<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Signup</title>

<style>
body { margin:0; padding:0; font-family:Arial; background:white; display:flex; justify-content:center; }
#app { width:380px; height:100vh; border:4px solid #000; display:flex; flex-direction:column; }
#topBar { height:60px; border-bottom:4px solid #000; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:bold; position:relative; }
#backBtn { position:absolute; left:10px; width:35px; height:35px; border:3px solid #000; border-radius:6px; cursor:pointer; }

main { padding:20px; display:flex; flex-direction:column; gap:20px; }

#avatarBtn {
    width:80px; height:80px;
    border:3px solid #000;
    border-radius:10px;
    align-self:center;
    cursor:pointer;
    background-size:cover;
    background-position:center;
}

input { height:45px; border:3px solid #000; padding:10px; }

#goBtn {
    height:50px;
    border:3px solid #000;
    border-radius:6px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
}
</style>
</head>
<body>

<div id="app">

    <div id="topBar">
        <div id="backBtn" onclick="location.href='/chat/login'"></div>
        Signup
    </div>

    <main>
        <div id="avatarBtn"></div>

        <input id="avatarInput" type="file" accept="image/jpeg,image/png" style="display:none">

        <input id="name" type="text" placeholder="Name">
        <input id="email" type="text" placeholder="Email">
        <input id="pw" type="password" placeholder="Passwort">

        <div id="goBtn" onclick="sendSignup()">Go</div>
    </main>

</div>

<script>
const avatarBtn = document.getElementById("avatarBtn");
const avatarInput = document.getElementById("avatarInput");

avatarBtn.addEventListener("click", () => avatarInput.click());

avatarInput.addEventListener("change", () => {
    const file = avatarInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
        avatarBtn.style.backgroundImage = `url(${reader.result})`;
    };
    reader.readAsDataURL(file);
});

// ----------------------
//  WEBSOCKET SIGNUP
// ----------------------

async function sendSignup() {
    const name = document.getElementById("name").value;
    const email = document.getElementById("email").value;
    const pw = document.getElementById("pw").value;

    const file = avatarInput.files[0];
    if (!file) {
        alert("Bitte Profilbild auswÃ¤hlen");
        return;
    }

    const imgArrayBuffer = await file.arrayBuffer();
    const imgBytes = new Uint8Array(imgArrayBuffer);

    const ws = new WebSocket("ws://144.76.57.59:21982/");

    ws.binaryType = "arraybuffer";

    ws.onopen = () => {
        // Erst JSON send
        const jsonData = {
            name,
            email,
            password: pw,
            img_size: imgBytes.length
        };

        ws.send(JSON.stringify(jsonData));

        // Danach Bild senden
        ws.send(imgBytes);
    };

    ws.onmessage = (msg) => {
        if (msg.data === "OK") {
            alert("Account wurde erstellt!");
            location.href = "/chat";
        } else {
            alert("Server-Antwort: " + msg.data);
        }
    };

    ws.onerror = (err) => {
        console.error(err);
        alert("WebSocket Fehler");
    };
}
</script>

</body>
    </html>
