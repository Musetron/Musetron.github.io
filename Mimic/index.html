<!DOCTYPE html><html lang="de">
<head>
<meta charset="UTF-8">
<title>Live Effekt Audio Sampler</title>
</head>
<body>
<h1>Live Effekt Audio Sampler</h1>
<button id="startBtn">Start</button>
<script>
const startBtn = document.getElementById('startBtn');startBtn.onclick = async () => {
const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const source = audioCtx.createMediaStreamSource(stream);

const analyser = audioCtx.createAnalyser();
analyser.fftSize = 2048;
source.connect(analyser);
const dataArray = new Float32Array(analyser.fftSize);

const SILENCE_THRESHOLD = 0.02;
const MIN_WORD_DURATION = 0.25; // Sekunden
let recording = false;
let currentBuffer = [];
const bufferSampleRate = audioCtx.sampleRate;
let savedWords = [];
let playbackBusy = false;

function rms(arr){
    let sum = 0;
    for (let i=0;i<arr.length;i++) sum += arr[i]*arr[i];
    return Math.sqrt(sum/arr.length);
}

function processAudio(){
    analyser.getFloatTimeDomainData(dataArray);
    const level = rms(dataArray);

    if(level > SILENCE_THRESHOLD){
        recording = true;
        currentBuffer.push(...dataArray);
    } else if(recording){
        recording = false;
        const duration = currentBuffer.length / bufferSampleRate;
        if(duration >= MIN_WORD_DURATION){
            saveWord(currentBuffer.slice());
        }
        currentBuffer = [];
    }

    // Selbstständiges Abspielen
    if(!playbackBusy && savedWords.length > 0 && Math.random() < 0.002){
        playRandomWords();
    }

    requestAnimationFrame(processAudio);
}

processAudio();

function saveWord(floatArray){
    const buffer = audioCtx.createBuffer(1, floatArray.length, bufferSampleRate);
    buffer.copyToChannel(Float32Array.from(floatArray),0,0);
    savedWords.push(buffer);

    // Sofort abspielen, falls frei
    if(!playbackBusy){
        playRandomWords();
    }
}

function playRandomWords(){
    if(savedWords.length === 0) return;
    playbackBusy = true;
    const numWords = Math.floor(Math.random()*3)+1;
    let delay = 0;
    for(let i=0;i<numWords;i++){
        const word = savedWords[Math.floor(Math.random()*savedWords.length)];
        const src = audioCtx.createBufferSource();
        src.buffer = word;

        // Effekte live
        const distortion = audioCtx.createWaveShaper();
        distortion.curve = new Float32Array(65536).map((v,j)=>Math.tanh((j-32768)/32768*10));
        distortion.oversample='4x';

        const tremolo = audioCtx.createGain();
        const lfo = audioCtx.createOscillator();
        lfo.type='sawtooth';
        lfo.frequency.value = 100;
        const lfoGain = audioCtx.createGain();
        lfoGain.gain.value = 1.0;
        lfo.connect(lfoGain);
        lfoGain.connect(tremolo.gain);
        lfo.start();

        // Telefon Bandpass 400–3200 Hz
        const bandpass = audioCtx.createBiquadFilter();
        bandpass.type='bandpass';
        bandpass.frequency.value=1800; // Mittenfrequenz
        bandpass.Q.value = 0.7; // Bandbreite = ungefähr 400–3200 Hz

        // Pitch Down
        src.playbackRate.value = 0.707;

        src.connect(distortion);
        distortion.connect(tremolo);
        tremolo.connect(bandpass);
        bandpass.connect(audioCtx.destination);

        src.start(audioCtx.currentTime + delay);
        delay += word.duration + 0.3 + Math.random()*0.4; // Pause zwischen 0.3–0.7 s
    }

    // Nach Playback frei geben
    setTimeout(()=>{playbackBusy=false;}, (delay+0.1)*1000);
}

};
</script>

</body>
    </html>
