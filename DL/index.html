<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Delay Lama</title>
<style>
html, body {
  margin:0; padding:0; width:100%; height:100%;
  background:#111;
  display:flex; flex-direction:column;
  justify-content:flex-end; align-items:center;
  overflow:hidden;
}

#playArea {
  width:80%; height:300px;
  background:#222; border:2px solid #fff;
  border-radius:12px; position:relative;
  margin-bottom:20px; overflow:hidden;
  cursor:pointer;
}

#playArea canvas{
  position:absolute; top:0; left:0;
  pointer-events:none;
}

.lama{
  position:absolute; top:20px;
  left:50%; transform:translateX(-50%);
  background-image:url('./DelayLama.png');
  background-repeat:no-repeat;
  image-rendering:pixelated;
  pointer-events:none;
}

.slider-container {
  display:flex;
  flex-direction:column;
  align-items:center;
  margin-bottom:20px;
  color:white;
}
</style>
</head>
<body>

<div id="playArea"></div>
<div class="slider-container">
  <label for="hallSlider">Delay Lama</label>
  <input type="range" id="hallSlider" min="0" max="1" step="0.01" value="0.3">
</div>
<div class="lama" id="lama"></div>

<script>
// ================= GLOBAL =================
let audioCtx=null, filters=[];
const C2=65.41, C3=130.81;
const vowels=['I','E','A','U','O'];
const vowelFormants={
  A:[800,1150,2900],
  E:[500,1700,2500],
  I:[350,2000,2800],
  O:[450,800,2830],
  U:[325,700,2530]
};

const playArea=document.getElementById('playArea');
const lama=document.getElementById('lama');
const hallSlider=document.getElementById('hallSlider');

// ================= VIBRATO =================
const vibratoDepth = 5;
const vibratoSpeed = 6;
let vibratoStartTime = 0;
let vibratoAmplitude = vibratoDepth;

// ================= MASTER HALL / DELAY =================
let convolver=null, wetGain=null, delayNode=null, feedbackGain=null;

function createReverbBuffer(ctx,duration=2){
  const sampleRate=ctx.sampleRate;
  const length=sampleRate*duration;
  const buffer=ctx.createBuffer(2,length,sampleRate);
  for(let ch=0;ch<2;ch++){
    const data=buffer.getChannelData(ch);
    for(let i=0;i<length;i++){
      data[i]=(Math.random()*2-1)*Math.pow(1-i/length,3);
    }
  }
  return buffer;
}

function setupMasterEffect(gainNode){
  if(!audioCtx) return;

  convolver=audioCtx.createConvolver();
  convolver.buffer=createReverbBuffer(audioCtx,2);

  delayNode=audioCtx.createDelay(5.0);
  delayNode.delayTime.value=0.25;

  feedbackGain=audioCtx.createGain();
  feedbackGain.gain.value=0.3;

  wetGain=audioCtx.createGain();
  wetGain.gain.value=parseFloat(hallSlider.value);

  delayNode.connect(feedbackGain);
  feedbackGain.connect(delayNode);

  delayNode.connect(wetGain);
  convolver.connect(wetGain);
  wetGain.connect(audioCtx.destination);

  hallSlider.addEventListener('input',()=>{ if(wetGain) wetGain.gain.value=parseFloat(hallSlider.value); });

  if(gainNode){
    gainNode.connect(convolver);
    gainNode.connect(delayNode);
  }
}

// ================= AUDIO + PATTERN =================
// Pattern: Zeitoffsets in Sekunden
const pattern = [0,0.25,0.5,0.75,1,1.25,1.5,1.75,2];

function playPattern(x,y){
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  audioCtx.resume();

  filters=[];
  for(let i=0;i<3;i++){
    const f=audioCtx.createBiquadFilter(); f.type='bandpass'; f.Q.value=20;
    filters.push(f);
  }

  const now = audioCtx.currentTime;

  pattern.forEach((offset)=>{
    const osc1 = audioCtx.createOscillator();
    const osc2 = audioCtx.createOscillator();
    osc1.type=osc2.type='sawtooth'; osc2.detune.value=3;

    const gainNode = audioCtx.createGain();
    gainNode.gain.value=0.5;

    const merger=audioCtx.createGain();
    osc1.connect(merger); osc2.connect(merger);
    filters.forEach(f=>{ merger.connect(f); f.connect(gainNode); });

    gainNode.connect(audioCtx.destination);

    // Hall/Delay
    setupMasterEffect(gainNode);

    // Pitch + Formants f√ºr Lama
    const rect=playArea.getBoundingClientRect();
    const ratioX=Math.min(Math.max((x-rect.left)/rect.width,0),1);
    const freq=C2+(C3-C2)*ratioX;
    osc1.frequency.setValueAtTime(freq, now+offset);
    osc2.frequency.setValueAtTime(freq, now+offset);

    const ratioY=Math.min(Math.max((y-rect.top)/rect.height,0),1);
    const idx=ratioY*(vowels.length-1);
    const l=Math.floor(idx), u=Math.min(l+1,vowels.length-1);
    const t=idx-l;
    for(let i=0;i<3;i++){
      const fval=vowelFormants[vowels[l]][i]*(1-t)+vowelFormants[vowels[u]][i]*t;
      filters[i].frequency.setTargetAtTime(fval, now+offset, 0.01);
    }

    // Start/Stop
    osc1.start(now+offset);
    osc2.start(now+offset);
    osc1.stop(now+offset+0.15);
    osc2.stop(now+offset+0.15);
  });
}

// ================= LAMA =================
const img=new Image();
img.src='./DelayLama.png';
img.onload=()=>{
  const cols=5, rows=6, fw=img.width/cols, fh=img.height/rows;
  lama.style.width=fw+'px'; lama.style.height=fh+'px';

  let mouseDown=false, lastY=0, idleFrame=0, lastIdleUpdate=0;

  function setFrame(f){
    const z=f-1, row=z%rows, col=Math.floor(z/rows);
    lama.style.backgroundPosition=`-${col*fw}px -${(rows-1-row)*fh}px`;
  }

  function getFrameFromY(y, now){
    const rect=playArea.getBoundingClientRect();
    let r=1-((y-rect.top)/rect.height); r=Math.max(0,Math.min(1,r));

    if(mouseDown){
      if(r<=0.25) return 12-Math.floor(r/0.25*6);
      else if(r<=0.5) return 18-Math.floor((r-0.25)/0.25*6);
      else if(r<=0.75) return 24-Math.floor((r-0.5)/0.25*6);
      else return 30-Math.floor((r-0.75)/0.25*6);
    } else {
      if(now - lastIdleUpdate > 250){ idleFrame++; lastIdleUpdate=now; }
      return (idleFrame%6)+1;
    }
  }

  function animate(now){
    const frame=getFrameFromY(lastY, now);
    setFrame(frame);
    requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);

  playArea.addEventListener('mousedown',e=>{
    mouseDown=true; lastY=e.clientY;
    playPattern(e.clientX,e.clientY);
  });

  document.addEventListener('mouseup',()=>{ mouseDown=false; });
  playArea.addEventListener('mousemove',e=>{ if(mouseDown) lastY=e.clientY; });
};

// ================= CANVAS =================
const canvas=document.createElement('canvas');
playArea.appendChild(canvas);
const ctx=canvas.getContext('2d');

function resizeCanvas(){
  const rect=playArea.getBoundingClientRect();
  canvas.width=rect.width; canvas.height=rect.height;
  drawKeyboardStripes();
}

function drawKeyboardStripes(){
  const numKeys = 13;
  const whiteKeys = [0,2,4,5,7,9,11,12];
  const keyWidth = canvas.width / numKeys;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  for(let i=0;i<numKeys;i++){
    ctx.fillStyle = whiteKeys.includes(i) ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.4)';
    ctx.fillRect(i*keyWidth, 0, keyWidth, canvas.height);

    if(i<numKeys-1){
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo((i+1)*keyWidth, 0);
      ctx.lineTo((i+1)*keyWidth, canvas.height);
      ctx.stroke();
    }
  }
}

resizeCanvas();
window.addEventListener('resize',resizeCanvas);
</script>

</body>
</html>
