<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Live 2D-Mikrofon-Rauschen</title>
<style>
  body { margin: 0; background: black; overflow: hidden; }
  canvas { display: block; image-rendering: pixelated; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// Canvas-Größe (klein für pixeligen Look)
const imgWidth = 64;
const imgHeight = 64;
canvas.width = imgWidth;
canvas.height = imgHeight;
canvas.style.width = window.innerWidth + "px";
canvas.style.height = window.innerHeight + "px";

// Stabilisierung: gleitender Mittelwert über Frames
const alpha = 0.2; // 0=no smoothing, 1=stabil aber träge
let stabilizedData = new Float32Array(imgWidth * imgHeight);

navigator.mediaDevices.getUserMedia({ audio: true })
.then(stream => {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const source = audioCtx.createMediaStreamSource(stream);
  const analyser = audioCtx.createAnalyser();
  analyser.fftSize = imgWidth * imgHeight * 2; // genug Samples für 2D
  source.connect(analyser);

  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);

  function draw() {
    requestAnimationFrame(draw);

    // Rohsamples abrufen
    analyser.getByteTimeDomainData(dataArray);

    // In 2D-Matrix gießen + normalisieren
    for (let i = 0; i < stabilizedData.length; i++) {
      const val = dataArray[i % bufferLength] / 255; // 0..1
      stabilizedData[i] = stabilizedData[i] * (1 - alpha) + val * alpha; // gleitender Mittelwert
    }

    // Bild erzeugen
    const imgData = ctx.createImageData(imgWidth, imgHeight);
    for (let i = 0; i < stabilizedData.length; i++) {
      const color = Math.floor(stabilizedData[i] * 255);
      imgData.data[i * 4 + 0] = color;
      imgData.data[i * 4 + 1] = color;
      imgData.data[i * 4 + 2] = color;
      imgData.data[i * 4 + 3] = 255;
    }

    ctx.putImageData(imgData, 0, 0);
  }

  draw();
})
.catch(err => {
  console.error("Mikrofon Zugriff verweigert:", err);
});
</script>
</body>
</html>
