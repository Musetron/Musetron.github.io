<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spirit Analyzer – Stabil Version</title>
<style>
html,body{height:100%;margin:0;overflow:hidden;background:black;color:#0f0;font-family:monospace;}
#cloudCanvas{display:block;width:100vw;height:100vh;}
#recordBtn{
  position:fixed;top:10px;left:10px;padding:10px 20px;font-size:16px;z-index:10;
}
#log{
  position:fixed;top:10px;right:10px;width:360px;height:280px;overflow:auto;
  background:rgba(0,0,0,0.6);color:#0f0;font-family:monospace;font-size:14px;
  padding:5px;border-radius:5px;z-index:10;white-space:pre;
}
</style>
</head>
<body>
<button id="recordBtn">Start Recording</button>
<div id="log"></div>
<canvas id="cloudCanvas"></canvas>

<script>
// --- Spiritliste ---
const ghosts = [
  "Thermisches Rauschen","Elektromagnetische Interferenz","Hintergrundstrahlung",
  "Mikrofonrauschen","Signalreflexion","Ultraschall-Feedback","Infraschall-Drift",
  "Elektrostatik-Puls","Kabelinduktion","Schumannresonanz-Anomalie","Magnetfeld-Drift",
  "Statische Entladung","Ionisationsflackern","Resonanzfrequenz-Welle","Feldrauschen",
  "Photonenrauschen","Luftdruckmodulation","Quantisierungsrauschen","Lichtinterferenz","Akustische Wellenüberlagerung",
  "Photonischer Flux","Quanteninferenz-Spur","Neutrino-Spur","Bioplasma-Knoten",
  "Energiecluster","Magnetische Turbulenz","Elektroplasmatische Entladung","Vortex-Welle",
  "Feldfluktuation","Resonanzfeld-Anomalie","Subraum-Energiefluss","Plasmawirbel",
  "EMF-Spike","Ionische Resonanz","Neurofeld-Schwingung","Elektronenwolke",
  "Biophotonischer Impuls","Gravitationsmikropuls","Energiegradient","Interferenzspektrum",
  "Lichtorb (niedrig)","Lichtorb (mittel)","Lichtorb (hell)","Staubreflexion",
  "Energieblase","Plasma-Orb","Photonische Kugel","Kalte Lichtkugel","Ionisierte Sphäre",
  "Wärmeorb","Bewegungsmuster-Orb","Smaragd-Lichtpunkt","Roter Schimmer","Blauer Impuls",
  "Weiße Manifestation","Transparente Kugel","Langsame Rotation","Zitternde Kugel",
  "Orbschwarm","Anomalie im Lichtfeld",
  "Energieabdruck","Resonanzkörper","Residualfeld","Ektoplasmatische Welle",
  "Astrale Spur","Lebensenergie-Fragment","Mentale Schwingung","Aura-Reflexion",
  "Emotionales Feld","Bewusstseins-Schatten","Projektion eines Willens","Restenergie",
  "Zeitresonanz","Traumanker","Gedankenform","Bioenergetisches Echo",
  "Anwesenheitsrest","Energiegeflecht","Manifestationspunkt","Geistige Verdichtung",
  "Seelenfragment","Wanderseele","Ahnenenergie","Verirrte Präsenz","Schutzgeist",
  "Verbundene Seele","Ruhende Essenz","Halbbewusstes Echo","Astraler Reisender",
  "Inkarnationsspur","Alte Seele","Verlorene Erinnerung","Zeitlose Präsenz","Bindende Seele",
  "Unvollendete Energie","Gebundene Erinnerung","Transzendente Projektion","Innerer Wächter","Aufgestiegene Präsenz",
  "Domovoi","Brownie","Zashiki-warashi","Tomte / Nisse","Poltergeist","Onryō",
  "La Llorona","Banshee","Kitsune","Revenant","Jiangshi","Manananggal","Vetala",
  "Pontianak","Dullahan","Wraith","Tikoloshe","Pishacha","Lutin","Huli Jing","Gashadokuro",
  "Phantom","Erscheinung im Nebel","Schattenwesen","Flüsterer","Fensterspiegelung",
  "Träumerische Gestalt","Wächter der Schwelle","Seelenführer","Stiller Beobachter",
  "Lurker","Schattendämon","Incubus","Succubus","Obskurum","Leere Präsenz",
  "Nachtmahre","Dämonischer Knoten","Besessenheitsfragment","Abyssischer Rufer",
  "Wurzelfresser","Traumschlucker","Kollektive Angstform","Energiezehrer","Nether-Manifestation",
  "Archont","Entropischer Parasit","Schwarzer Spiegel","Verdrehter Geist","Höllisches Echo"
];

// --- Spirit Logger ---
const logDiv = document.getElementById('log');
let recording = false;
let recordInterval = null;
let logLines = [];
let currentSpiritLevel = 0;
let lastSpiritLevel = 0;

function addLogLine(line){
  logLines.push(line);
  if(logLines.length>20) logLines.shift();
  logDiv.innerText = logLines.join("\n");
}

function saveTxtFile(){
  const blob = new Blob([logLines.join("\n")], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='spirit_log.txt';a.click();URL.revokeObjectURL(url);
}

document.getElementById('recordBtn').addEventListener('click', ()=>{
  if(recording){
    clearInterval(recordInterval);
    recording=false;
    saveTxtFile();
    document.getElementById('recordBtn').innerText='Start Recording';
    addLogLine('Aufnahme beendet. Datei gespeichert.');
  } else {
    recording=true;
    document.getElementById('recordBtn').innerText='Stop Recording';
    addLogLine('Aufnahme gestartet...');
    recordInterval=setInterval(logSpirit,3000);
  }
});

function logSpirit(){
  const now=new Date().toLocaleTimeString();
  const spirit = Math.round(currentSpiritLevel);
  const change = Math.round(100 - Math.abs(spirit - lastSpiritLevel)); // Stabilität
  lastSpiritLevel = spirit;

  if(spirit>75){
    const ghost=ghosts[Math.floor(Math.random()*(ghosts.length-60)+60)];
    addLogLine(`[${now}] ⚡ HOHER Spirit-Pegel: ${spirit} | Stabilität: ${change}% | Detektiert: ${ghost}`);
  } else if(spirit>40){
    const ghost=ghosts[Math.floor(Math.random()*(60-40)+40)];
    addLogLine(`[${now}] Spirit-Pegel: ${spirit} | Stabilität: ${change}% | Präsenz: ${ghost}`);
  } else if(spirit>10){
    const ghost=ghosts[Math.floor(Math.random()*40)];
    addLogLine(`[${now}] Schwache Energie (${spirit}) | Stabilität: ${change}% | ${ghost}`);
  } else {
    addLogLine(`[${now}] Spirit-Pegel: ${spirit} | unklar | Stabilität: ${change}%`);
  }
}

// --- Canvas Wolkenanimation ---
const PARTICLE_SRC='https://i.ibb.co/BHnTHLDB/Add-Text-11-09-09-39-04.png';
const BACKGROUND_SRC='https://i.ibb.co/tMRLBLnR/neon-green-wireframe-grid-room-3d-perspective-background-futuristic-digital-outline-space-geometric.jpg';
const BLINK_IMAGE_SRC='https://i.ibb.co/yc5kSK8v/1762683053390.png';
const canvas=document.getElementById('cloudCanvas');
const ctx=canvas.getContext('2d');
let DPR=Math.max(1,window.devicePixelRatio||1);

function resize(){
  DPR=Math.max(1,window.devicePixelRatio||1);
  canvas.width=Math.floor(window.innerWidth*DPR);
  canvas.height=Math.floor(window.innerHeight*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize',resize);
resize();

const img=new Image(); img.crossOrigin='anonymous'; img.src=PARTICLE_SRC;
const bg=new Image(); bg.crossOrigin='anonymous'; bg.src=BACKGROUND_SRC;
const blinkImg=new Image(); blinkImg.crossOrigin='anonymous'; blinkImg.src=BLINK_IMAGE_SRC;
let blinkVisible=true;
setInterval(()=>{blinkVisible=!blinkVisible;},1000);

const LAYERS=[
  {count:6,speed:0.06,scaleRange:[1.0,1.5],alpha:0.4,depth:0.6},
  {count:10,speed:0.1,scaleRange:[0.7,1.1],alpha:0.5,depth:0.9},
  {count:14,speed:0.14,scaleRange:[0.5,0.9],alpha:0.6,depth:1.4}
];

let particles=[];
function rand(a,b){return a+Math.random()*(b-a);}
function createParticle(layer){
  const s=rand(layer.scaleRange[0],layer.scaleRange[1]);
  return {x:rand(-200,200),y:rand(-100,100),z:rand(50,400),
          vx:rand(-layer.speed,layer.speed),vy:rand(-0.02,0.02),vz:rand(-0.1,0.1),
          scale:s,alpha:0,targetAlpha:rand(0.4*layer.alpha,0.8*layer.alpha),
          rot:rand(0,Math.PI*2),rotSpeed:rand(-0.002,0.002),layer,
          life:rand(10000,20000),age:0,fadeDuration:2000};
}
function initParticles(){particles=[];for(const l of LAYERS)for(let i=0;i<l.count;i++)particles.push(createParticle(l));}
img.onload=()=>{initParticles();last=performance.now();requestAnimationFrame(loop);};

let last=performance.now(),masterAlpha=0;

// --- Mikrofon mit Bandpass 2–5 kHz ---
navigator.mediaDevices.getUserMedia({ audio:true }).then(stream=>{
  const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const source=audioCtx.createMediaStreamSource(stream);
  const bandpass=audioCtx.createBiquadFilter();
  bandpass.type="bandpass"; bandpass.frequency.value=3500; bandpass.Q.value=0.7;
  const analyser=audioCtx.createAnalyser(); analyser.fftSize=512;
  source.connect(bandpass); bandpass.connect(analyser);
  const dataArray=new Uint8Array(analyser.frequencyBinCount);
  function updateMic(){
    analyser.getByteTimeDomainData(dataArray);
    let sum=0;
    for(let i=0;i<dataArray.length;i++){const v=(dataArray[i]-128)/128;sum+=v*v;}
    const rms=Math.sqrt(sum/dataArray.length);
    masterAlpha=Math.min(1,rms*5);
    currentSpiritLevel=Math.min(100,Math.round(masterAlpha*100*1.5));
  }
  setInterval(updateMic,100);
}).catch(err=>{console.log("Mic error",err); masterAlpha=0.5;});

// --- 3D-Projektion ---
function project3D(x,y,z){const fov=800;const s=fov/(fov+z);return {x:canvas.width/2+x*s,y:canvas.height/2+y*s,scale:s};}

function loop(ts){
  const dt=ts-last; last=ts;
  if(bg.complete&&bg.naturalWidth) ctx.drawImage(bg,0,0,canvas.width,canvas.height);

  for(const layer of LAYERS){
    for(const p of particles){
      if(p.layer!==layer)continue;
      p.age+=dt;
      p.x+=p.vx; p.y+=p.vy; p.z+=p.vz; p.rot+=p.rotSpeed;

      if(p.age<p.fadeDuration)p.alpha=(p.age/p.fadeDuration)*p.targetAlpha;
      else if(p.age>p.life-p.fadeDuration)p.alpha=p.targetAlpha*((p.life-p.age)/p.fadeDuration);
      else p.alpha=p.targetAlpha;
      p.alpha=Math.min(p.alpha,0.9);

      const proj=project3D(p.x,p.y,Math.max(0.1,p.z));
      const scaleProj=Math.min(proj.scale,1.5);
      const wP=img.width*p.scale*0.45*scaleProj;
      const hP=img.height*p.scale*0.45*scaleProj;

      ctx.save(); ctx.translate(proj.x,proj.y); ctx.rotate(p.rot); ctx.globalAlpha=p.alpha*masterAlpha;
      if(img.complete&&img.naturalWidth)ctx.drawImage(img,-wP/2,-hP/2,wP,hP);
      ctx.restore();

      if(p.age>p.life || p.z<0){const idx=particles.indexOf(p);if(idx!==-1)particles[idx]=createParticle(layer);}
    }
  }

  if(blinkVisible && blinkImg.complete){
    const ratio=Math.min(canvas.width/2/blinkImg.width,canvas.height/2/blinkImg.height);
    const w=blinkImg.width*ratio,h=blinkImg.height*ratio;
    ctx.drawImage(blinkImg,canvas.width/8,canvas.height-h-canvas.height/8,w,h);
  }

  requestAnimationFrame(loop);
}
</script>
</body>
</html>
