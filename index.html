<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Spirit-Logger</title>
<style>
  html,body{
    height:100%;margin:0;overflow:hidden;
    background:#040404;color:#fff;
    font-family:sans-serif;
    touch-action:none;
  }
  #cloudCanvas{
    display:block;
    width:100vw;
    height:100vh;
    position:absolute;
    top:0;left:0;
    z-index:0;
  }
  .btn{
    position:fixed;
    top:10px;
    left:10px;
    padding:10px 16px;
    font-size:15px;
    border-radius:6px;
    border:none;
    background:#222;
    color:#fff;
    cursor:pointer;
    z-index:11;
    box-shadow:0 4px 14px rgba(0,0,0,0.6);
  }
  #info{
    position:fixed;
    top:10px;
    right:10px;
    width:35vw;
    max-width:400px;
    height:40vh;
    max-height:300px;
    overflow:auto;
    background:rgba(0,0,0,0.66);
    color:#7CFF7C;
    font-family:monospace;
    font-size:13px;
    padding:10px;
    border-radius:8px;
    z-index:11;
    line-height:1.3;
  }
  #status{
    position:fixed;
    bottom:12px;
    left:12px;
    color:#ccc;
    font-family:monospace;
    font-size:13px;
    z-index:11;
    background:rgba(0,0,0,0.35);
    padding:6px 10px;
    border-radius:6px;
  }
  #gainSlider{
    position:fixed;
    left:70px;
    top:60px;
    height:200px;
    width:30px;
    writing-mode: bt-lr;
    -webkit-appearance: slider-vertical;
    appearance: slider-vertical;
    z-index:11;
  }
  @media (orientation: landscape) {
    #info{
      width:45vw;
      height:60vh;
      font-size:12px;
    }
    #gainSlider{
      left:10px;
      top:50%;
      transform:translateY(-50%);
    }
    #recordBtn{
      top:auto;
      bottom:10px;
      left:10px;
    }
    #status{
      bottom:10px;
      left:10px;
      font-size:12px;
    }
  }
</style>
</head>
<body>

<button id="recordBtn" class="btn">Start Recording</button>
<input id="gainSlider" type="range" min="0.2" max="3" value="1" step="0.01" orient="vertical">
<div id="info">Lade List.txt‚Ä¶</div>
<canvas id="cloudCanvas"></canvas>
<div id="status">Mikrofon: warten... ‚Ä¢ Gain: 1.00</div>

<script>
/* =========================
   Globals
   ========================= */
const LOG_INTERVAL_MS = 5000;
const STABILITY_WINDOW = 6;
const SMOOTH_ALPHA = 0.15;

const infoDiv = document.getElementById('info');
const statusDiv = document.getElementById('status');
const recordBtn = document.getElementById('recordBtn');
const gainSlider = document.getElementById('gainSlider');
const canvas = document.getElementById('cloudCanvas');
const ctx = canvas.getContext('2d');

let audioCtx, analyser, micSource, dataArray;
let gainFactor = 1.0;
let spiritFloat = 0;
let masterAlpha = 0;
let recording = false;

/* ========== Logging ========== */
let logLines = [];
function addLogLine(line){
  logLines.push(line);
  if(logLines.length > 200) logLines.shift();
  infoDiv.innerText = logLines.slice(-20).join("\n") || 'Keine Logs';
}
function saveTxtFile(filename='spirit_log.txt'){
  const blob = new Blob([logLines.join("\n")], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ========== Mikrofon Setup ========== */
async function initMic(){
  try {
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    await audioCtx.resume();
    micSource = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024;
    dataArray = new Float32Array(analyser.fftSize);
    micSource.connect(analyser);
    addLogLine('üéô Mikrofon aktiv.');
  } catch(err){
    addLogLine('‚ö†Ô∏è Mikrofonfehler: ' + err);
  }
}

function getCurrentLevel(){
  if(!analyser) return 0;
  analyser.getFloatTimeDomainData(dataArray);
  let sum = 0;
  for(let i=0;i<dataArray.length;i++) sum += dataArray[i]*dataArray[i];
  const rms = Math.sqrt(sum / dataArray.length);
  return rms * gainFactor;
}

/* ========== Gain Slider ========== */
gainSlider.addEventListener('input', ()=>{
  gainFactor = parseFloat(gainSlider.value);
  statusDiv.innerText = `Mikrofon: ${audioCtx ? "bereit" : "warten..."} ‚Ä¢ Gain: ${gainFactor.toFixed(2)}`;
});

/* ========== Aufnahme-Button ========== */
recordBtn.addEventListener('click', async ()=>{
  if(!audioCtx) await initMic();
  recording = !recording;
  recordBtn.innerText = recording ? 'Stop Recording' : 'Start Recording';
  if(recording){
    await audioCtx.resume();
    addLogLine('Recording gestartet.');
  } else {
    saveTxtFile();
    addLogLine('Recording gestoppt & gespeichert.');
  }
});

/* ========== Pegel / Spirit Berechnung ========== */
function updateAudio(){
  if(recording && analyser){
    const level = getCurrentLevel();
    spiritFloat = spiritFloat*(1-SMOOTH_ALPHA) + Math.min(100, level * 250)*SMOOTH_ALPHA;
    masterAlpha = Math.min(1, spiritFloat / 100);
  } else {
    // Idle-Wolkenruhe (leichter Schwebeeffekt)
    masterAlpha = 0.15 + 0.05 * Math.sin(performance.now()/1000);
  }
  requestAnimationFrame(updateAudio);
}
updateAudio();

/* ========== Logging ========== */
setInterval(()=>{
  if(recording && audioCtx){
    const now = new Date();
    const msg = `[${now.toLocaleTimeString()}] Pegel: ${spiritFloat.toFixed(2)} | Gain: ${gainFactor.toFixed(2)}`;
    addLogLine(msg);
  }
}, LOG_INTERVAL_MS);

/* ========== Canvas Wolke ========== */
const PARTICLE_SRC='https://i.ibb.co/BHnTHLDB/Add-Text-11-09-09-39-04.png';
const BACKGROUND_SRC='https://i.ibb.co/tMRLBLnR/neon-green-wireframe-grid-room-3d-perspective-background-futuristic-digital-outline-space-geometric.jpg';

let DPR = Math.max(1, window.devicePixelRatio || 1);
function resizeCanvas(){
  DPR = Math.max(1, window.devicePixelRatio || 1);
  canvas.width = Math.floor(window.innerWidth * DPR);
  canvas.height = Math.floor(window.innerHeight * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

const img = new Image(); img.crossOrigin='anonymous'; img.src = PARTICLE_SRC;
const bg = new Image(); bg.crossOrigin='anonymous'; bg.src = BACKGROUND_SRC;

const LAYERS = [
  {count:8,speed:0.06,scaleRange:[1.0,1.5],alpha:0.4,depth:0.6},
  {count:12,speed:0.1,scaleRange:[0.7,1.1],alpha:0.5,depth:0.9},
  {count:16,speed:0.14,scaleRange:[0.5,0.9],alpha:0.6,depth:1.4}
];

let particles = [];
function rand(a,b){ return a + Math.random()*(b-a); }
function createParticle(layer){
  const s = rand(layer.scaleRange[0], layer.scaleRange[1]);
  return {
    x: rand(-200,200), y: rand(-100,100), z: rand(0,400),
    vx: rand(-layer.speed, layer.speed), vy: rand(-0.02,0.02), vz: rand(-0.1,0.1),
    scale: s, alpha:0, targetAlpha: rand(0.4*layer.alpha, 0.8*layer.alpha),
    rot: rand(0,Math.PI*2), rotSpeed: rand(-0.002,0.002), layer,
    life: rand(10000,20000), age:0, fadeDuration:2000
  };
}
function initParticles(){ particles=[]; for(const l of LAYERS) for(let i=0;i<l.count;i++) particles.push(createParticle(l)); }

img.onload = ()=>{ initParticles(); last=performance.now(); requestAnimationFrame(loop); };
let last = performance.now();

function project3D(x,y,z){
  const fov = 800;
  const scale = fov / (fov + z);
  return { x: canvas.width/2 + x*scale, y: canvas.height/2 + y*scale, scale: scale };
}

function loop(ts){
  const dt = ts - last; last = ts;
  if(bg.complete && bg.naturalWidth) ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);
  for(const layer of LAYERS){
    for(const p of particles){
      if(p.layer!==layer) continue;
      p.age += dt;
      p.x += p.vx*1.2*(1/p.layer.depth);
      p.y += p.vy*1.2;
      p.z += p.vz*1.2;
      p.rot += p.rotSpeed;
      if(p.age<p.fadeDuration) p.alpha=(p.age/p.fadeDuration)*p.targetAlpha;
      else if(p.age>p.life-p.fadeDuration)
        p.alpha=Math.max(0,p.targetAlpha*((p.life-p.age)/p.fadeDuration));
      else p.alpha=p.targetAlpha;
      const alphaFinal = p.alpha * masterAlpha;
      const proj = project3D(p.x,p.y,p.z);
      const wP = img.width*p.scale*0.45*proj.scale;
      const hP = img.height*p.scale*0.45*proj.scale;
      ctx.save();
      ctx.translate(proj.x,proj.y);
      ctx.rotate(p.rot);
      ctx.globalAlpha = alphaFinal;
      if(img.complete) ctx.drawImage(img,-wP/2,-hP/2,wP,hP);
      ctx.restore();
      if(p.age>p.life){
        const idx=particles.indexOf(p);
        if(idx!==-1) particles[idx]=createParticle(layer);
      }
    }
  }
  requestAnimationFrame(loop);
}

addLogLine('Spirit-Logger bereit. Wolke sichtbar. Dr√ºcke "Start Recording", um Pegel zu aktivieren.');
statusDiv.innerText = `Mikrofon: warten... ‚Ä¢ Gain: ${gainFactor.toFixed(2)}`;
</script>
</body>
  </html>
  
