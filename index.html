<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Mikrofon → Buchstaben Chat</title>
<style>
  body { font-family: monospace; background: #111; color: #0f0; padding: 20px; }
  #chat { white-space: pre-wrap; line-height: 1.5; max-width: 600px; margin: auto; }
  .message { margin-bottom: 1em; }
</style>
</head>
<body>
<h2>Mikrofon → Buchstaben Chat</h2>
<div id="chat"></div>

<script>
const chat = document.getElementById("chat");

navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(stream);
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024;
    source.connect(analyser);

    const dataArray = new Float32Array(analyser.fftSize);
    let currentMessage = "";
    let lastSoundTime = Date.now();
    const MESSAGE_TIMEOUT = 3000; // 3 Sekunden Inaktivität
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

    function getRMS(data) {
        let sum = 0;
        for (let i = 0; i < data.length; i++) {
            sum += data[i] * data[i];
        }
        return Math.sqrt(sum / data.length);
    }

    function rmsToChar(rms) {
        if(rms < 0.02) return ""; // Threshold
        const index = Math.floor(Math.min(rms * 50, 25)); // skaliert auf 0–25
        return letters[index] || " ";
    }

    function processAudio() {
        analyser.getFloatTimeDomainData(dataArray);
        const rms = getRMS(dataArray);

        if(rms > 0.02) {
            lastSoundTime = Date.now();
            // mehrere Buchstaben pro Frame für dichteres Ergebnis
            for(let i=0; i<5; i++) {
                currentMessage += rmsToChar(rms);
            }
        }

        // Nachricht nach 3 Sekunden Inaktivität
        if(currentMessage && Date.now() - lastSoundTime > MESSAGE_TIMEOUT) {
            const messageDiv = document.createElement("div");
            messageDiv.className = "message";
            messageDiv.textContent = currentMessage;
            chat.appendChild(messageDiv);
            currentMessage = "";
        }

        requestAnimationFrame(processAudio);
    }

    processAudio();
}).catch(err => {
    console.error("Mikrofon nicht verfügbar:", err);
});
</script>
</body>
</html>
