<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Frequenz → Buchstaben Chat</title>
<style>
  body { font-family: monospace; background: #111; color: #0f0; padding: 20px; }
  #chat { white-space: pre-wrap; line-height: 1.5; max-width: 600px; margin: auto; }
  .message { margin-bottom: 1em; }
</style>
</head>
<body>
<h2>Frequenz → Buchstaben Chat (A–Z)</h2>
<div id="chat"></div>

<script>
const chat = document.getElementById("chat");

navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(stream);
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    source.connect(analyser);

    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    let currentMessage = "";
    let lastSoundTime = Date.now();
    const MESSAGE_TIMEOUT = 3000; // 3 Sekunden Inaktivität

    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

    function freqToChar(freq) {
        // 100, 200, 300 Hz = Leerzeichen
        if (Math.round(freq) === 100 || Math.round(freq) === 200 || Math.round(freq) === 300) return " ";

        // Frequenzen 100–300 Hz auf A–Z
        if(freq < 100) return "";
        if(freq > 300) return "";
        const index = Math.floor((freq - 100) / (200 / (letters.length - 1)));
        return letters[index] || "";
    }

    function processAudio() {
        analyser.getByteFrequencyData(dataArray);

        const sampleRate = audioCtx.sampleRate;
        const binCount = analyser.frequencyBinCount;

        let foundSound = false;

        for (let i = 0; i < binCount; i++) {
            const freq = i * sampleRate / analyser.fftSize;
            if (freq >= 100 && freq <= 300) {
                const magnitude = dataArray[i] / 255;
                if (magnitude > 0.05) { // kleiner Pegel-Threshold
                    currentMessage += freqToChar(freq);
                    foundSound = true;
                }
            }
        }

        if(foundSound) lastSoundTime = Date.now();

        // Nachricht nach 3 Sekunden Inaktivität abschließen
        if(currentMessage && Date.now() - lastSoundTime > MESSAGE_TIMEOUT) {
            const messageDiv = document.createElement("div");
            messageDiv.className = "message";
            messageDiv.textContent = currentMessage;
            chat.appendChild(messageDiv);
            currentMessage = "";
        }

        requestAnimationFrame(processAudio);
    }

    processAudio();
}).catch(err => {
    console.error("Mikrofon nicht verfügbar:", err);
});
</script>
</body>
</html>
