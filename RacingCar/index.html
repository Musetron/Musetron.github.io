<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Racing Car</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background-color: #121212;
    color: #aaa; /* Grau statt Lila */
    font-family: Arial, sans-serif;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
h1 {
    font-size: 2em;
    color: #aaa;
    margin: 0;
    text-align: center;
}
.pedal-container {
    display: flex;
    justify-content: space-between;
    width: 400px;
    margin-top: 40px;
}
.slider-container {
    display: flex;
    flex-direction: column;
    align-items: center;
}
input[type="range"].vertical {
    -webkit-appearance: slider-vertical;
    width: 40px;
    height: 150px;
    writing-mode: bt-lr;
    background: #333; 
    border-radius: 10px;
    accent-color: #aaa;
    cursor: grab;
    margin-bottom: 10px;
}
label { color: #aaa; }
.tacho-container {
    width: 400px;
    height: 200px;
    position: relative;
    margin-top: 20px;
}
.tacho-bg { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; height: auto; z-index: 1; }
.tacho { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
#needle { stroke: #ff0000; }
#needle circle { fill: #ff0000; }
</style>
</head>
<body>
<h1>Racing Car</h1>

<div class="tacho-container">
    <img src="https://i.ibb.co/7dc4fnhT/speedometer-PNG36.png" alt="Tacho" class="tacho-bg"/>
    <svg class="tacho" viewBox="0 0 400 200">
        <line id="needle" x1="200" y1="200" x2="200" y2="40" stroke="#ff0000" stroke-width="6" stroke-linecap="round"/>
        <circle cx="200" cy="200" r="8" fill="#ff0000"/>
    </svg>
</div>

<div class="pedal-container">
    <div class="slider-container">
        <input type="range" id="brakeSlider" class="vertical" min="0.01" max="0.1" step="0.001" value="0.02">
        <label>Bremse</label>
    </div>
    <div class="slider-container">
        <input type="range" id="gasSlider" class="vertical" min="0.01" max="0.1" step="0.001" value="0.03">
        <label>Gas</label>
    </div>
</div>

<script>
let audioContext;
let bufferSource;
let audioBuffer;
let gainNode;
let popBuffer;

const gasSlider = document.getElementById('gasSlider');
const brakeSlider = document.getElementById('brakeSlider');
const needle = document.getElementById('needle');

const idleVolume = 0.2;
let currentVolume = idleVolume;

const idlePitch = 1.0;
const maxPitch = 2.0;
let currentPitch = idlePitch;

let lastGasValue = 0;
let gasJustReleased = false;

async function loadAudio() {
    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();

    const response = await fetch("https://github.com/Musetron/Musetron.github.io/raw/refs/heads/main/RacingCar/engine.wav");
    const arrayBuffer = await response.arrayBuffer();
    audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

    const popResponse = await fetch("https://github.com/Musetron/Musetron.github.io/raw/refs/heads/main/RacingCar/pop.wav");
    const popArrayBuffer = await popResponse.arrayBuffer();
    popBuffer = await audioContext.decodeAudioData(popArrayBuffer);

    playBuffer();
}

function playBuffer() {
    if (bufferSource) bufferSource.stop();
    bufferSource = audioContext.createBufferSource();
    bufferSource.buffer = audioBuffer;
    bufferSource.loop = true;

    gainNode = audioContext.createGain();
    gainNode.gain.value = idleVolume;

    bufferSource.connect(gainNode).connect(audioContext.destination);
    bufferSource.start();
}

function playPop(tachoValue, deep = true) {
    const popSource = audioContext.createBufferSource();
    popSource.buffer = popBuffer;

    const popGain = audioContext.createGain();
    popGain.gain.value = 0.1 + Math.random() * 0.15;
    popSource.connect(popGain).connect(audioContext.destination);

    const basePitch = deep ? 0.25 : 0.4;
    popSource.playbackRate.value = basePitch + Math.random() * 0.2 + tachoValue * 0.15;
    popSource.start();
}

function animate() {
    const gasValue = parseFloat(gasSlider.value);
    const brakeValue = parseFloat(brakeSlider.value);

    const gasPressed = gasValue > 0.01;

    // Lautstärke jetzt stärker beim Gas
    const targetVolume = gasPressed ? idleVolume + 0.35 : idleVolume; // von 0.15 → 0.35 erhöht
    currentVolume += (targetVolume - currentVolume) * 0.05;

    // Pitch: Gas erhöht, Bremse beschleunigt Rückfall
    if (gasPressed) {
        currentPitch += gasValue * 0.05 * (maxPitch - currentPitch);
        currentPitch = Math.min(currentPitch, maxPitch);
    } else {
        let fallSpeed = 0.02 + (brakeValue || 0) * 0.5;
        currentPitch += (idlePitch - currentPitch) * fallSpeed;
    }

    if (gainNode) gainNode.gain.value = currentVolume;
    if (bufferSource) bufferSource.playbackRate.value = currentPitch;

    const tachoValue = (currentPitch - idlePitch) / (maxPitch - idlePitch);
    const angle = -90 + tachoValue * 180;
    needle.setAttribute('transform', `rotate(${angle} 200 200)`);

    // Pops nur beim Gas loslassen
    if (lastGasValue > 0.01 && gasValue <= 0.01) gasJustReleased = true;

    if (gasJustReleased) {
        gasJustReleased = false;
        const popCount = 3 + Math.floor(Math.random() * 4);
        for (let i = 0; i < popCount; i++) {
            setTimeout(() => playPop(tachoValue, Math.random() > 0.5), i * (100 + Math.random() * 150));
        }
    }

    lastGasValue = gasValue;
    requestAnimationFrame(animate);
}

loadAudio();
animate();
</script>
</body>
</html>
