<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Racing Car</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background-color: #121212;
    color: #aaa;
    font-family: Arial, sans-serif;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
h1 {
    font-size: 2em;
    color: #aaa;
    margin: 0;
    text-align: center;
}
.pedal-container {
    display: flex;
    justify-content: space-between;
    width: 400px;
    margin-top: 40px;
}
.slider-container {
    display: flex;
    flex-direction: column;
    align-items: center;
}
input[type="range"].vertical {
    -webkit-appearance: slider-vertical;
    width: 40px;
    height: 150px;
    writing-mode: bt-lr;
    background: #333;
    border-radius: 10px;
    accent-color: #aaa;
    cursor: grab;
    margin-bottom: 10px;
}
label { color: #aaa; }
.tacho-container {
    width: 400px;
    height: 200px;
    position: relative;
    margin-top: 20px;
}
.tacho-bg {
    position: absolute; 
    bottom: 0; 
    left: 50%; 
    transform: translateX(-50%); 
    width: 100%; 
    height: auto; 
    z-index: 1;
}
.tacho {
    position: absolute; 
    bottom: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    z-index: 2; 
    pointer-events: none;
}
#needle { stroke: #ff0000; }
#needle circle { fill: #ff0000; }
#unlockAudio {
    position: fixed;
    inset: 0;
    background: #000;
    color: white;
    font-size: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    cursor: pointer;
}
</style>
</head>
<body>

<div id="unlockAudio">Start</div>

<h1>Racing Car</h1>

<div class="tacho-container">
    <img src="https://i.ibb.co/7dc4fnhT/speedometer-PNG36.png" alt="Tacho" class="tacho-bg"/>
    <svg class="tacho" viewBox="0 0 400 200">
        <line id="needle" x1="200" y1="200" x2="200" y2="40" stroke="#ff0000" stroke-width="6" stroke-linecap="round"/>
        <circle cx="200" cy="200" r="8" fill="#ff0000"/>
    </svg>
</div>

<div class="pedal-container" id="sliderUI">
    <div class="slider-container">
        <input type="range" id="brakeSlider" class="vertical" min="0" max="1" step="0.001" value="0">
        <label>Brake</label>
    </div>
    <div class="slider-container">
        <input type="range" id="gasSlider" class="vertical" min="0" max="1" step="0.001" value="0">
        <label>Gas</label>
    </div>
</div>

<script>
let audioContext, bufferSource, audioBuffer, gainNode, popBuffer;
let gasValue = 0, brakeValue = 0;
let needleAngle = -90, needleVelocity = 0;
const needle = document.getElementById('needle');
const idleVolume = 0.2;
let currentVolume = idleVolume;
const idlePitch = 1.0;
const maxPitch = 2.0;
let currentPitch = idlePitch;
let lastGasValue = 0, gasJustReleased = false;
let sawOffset = 0, sawDirection = 1;
let holdMode = false;
let gasKickActive = false;

// --- AUDIO UNLOCK ---
document.getElementById("unlockAudio").addEventListener("click", unlockAudio);
document.getElementById("unlockAudio").addEventListener("touchstart", unlockAudio);

async function unlockAudio() {
    if (!audioContext)
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    await audioContext.resume();
    document.getElementById("unlockAudio").style.display = "none";
    loadAudio();
    animate();
}

// --- Gamepad ---
function readGamepadInput() {
    const pads = navigator.getGamepads ? navigator.getGamepads() : [];
    if (!pads) return;
    const gp = pads[0];
    if (!gp) return;

    const R2 = gp.buttons[7]?.value ?? 0;
    const L2 = gp.buttons[6]?.value ?? 0;
    const A = gp.buttons[0]?.pressed ?? false;

    holdMode = A;
    if (R2 || L2) document.getElementById("sliderUI").style.display = "none";

    gasValue = R2;
    brakeValue = L2;

    if (!gp.connected) {
        gasValue = parseFloat(document.getElementById("gasSlider").value);
        brakeValue = parseFloat(document.getElementById("brakeSlider").value);
    }
}

// --- Audio laden ---
async function loadAudio() {
    const response = await fetch("https://cdn.jsdelivr.net/gh/Musetron/Musetron.github.io/RacingCar/engine.wav");
    const arrayBuffer = await response.arrayBuffer();
    audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
    const popResponse = await fetch("https://cdn.jsdelivr.net/gh/Musetron/Musetron.github.io/RacingCar/pop.wav");
    const popArrayBuffer = await popResponse.arrayBuffer();
    popBuffer = await audioContext.decodeAudioData(popArrayBuffer);
    playBuffer();
}

// --- Motor Sound ---
function playBuffer() {
    if (bufferSource) bufferSource.stop();
    bufferSource = audioContext.createBufferSource();
    bufferSource.buffer = audioBuffer;
    bufferSource.loop = true;
    gainNode = audioContext.createGain();
    gainNode.gain.value = idleVolume;
    bufferSource.connect(gainNode).connect(audioContext.destination);
    bufferSource.start();
}

// --- Pop ---
function playPop(tachoValue, deep = true) {
    const popSource = audioContext.createBufferSource();
    popSource.buffer = popBuffer;
    const popGain = audioContext.createGain();
    popGain.gain.value = 0.1 + Math.random() * 0.15;
    popSource.connect(popGain).connect(audioContext.destination);
    const basePitch = deep ? 0.25 : 0.4;
    popSource.playbackRate.value = basePitch + Math.random() * 0.2 + tachoValue * 0.15;
    popSource.start();
}

// --- Animation ---
function animate() {
    readGamepadInput();

    // --- Tacho Berechnung ---
    let angleTarget;
    if (holdMode) {
        angleTarget = needleAngle + (-needleVelocity * 0.5); 
    } else {
        const tachoTarget = gasValue - brakeValue * 0.5;
        const clampedTarget = Math.max(0, Math.min(tachoTarget, 1));
        angleTarget = -90 + clampedTarget * 180;
    }

    const spring = (angleTarget - needleAngle) * 0.002;
    const damping = needleVelocity * 0.93;
    needleVelocity += spring - damping;

    if (!holdMode && needleAngle > -90) needleVelocity -= brakeValue * 0.7;

    needleAngle += needleVelocity;
    needleAngle = Math.max(-90, Math.min(needleAngle, 90));

    const tachoValue = (needleAngle + 90) / 180;
    if (tachoValue > 0.8) {
        const strength = (tachoValue - 0.8) / 0.2 * 2.5;
        sawOffset += sawDirection * (0.3 + Math.random() * 0.5) * strength;
        if (sawOffset > strength) sawDirection = -1;
        if (sawOffset < -strength) sawDirection = 1;
        needleAngle += sawOffset;
    }

    needle.setAttribute("transform", `rotate(${needleAngle} 200 200)`);

    // --- Audio Volume & Pitch (smooth + Gas-Kick) ---
    let targetVolume = idleVolume + gasValue * 0.35;

    if (gasValue > 0.01 && lastGasValue <= 0.01) {
        gasKickActive = true;
        setTimeout(() => { gasKickActive = false; }, 100);
    }
    let kickVolume = gasKickActive ? 0.2 : 0;
    targetVolume += kickVolume;

    currentVolume += (targetVolume - currentVolume) * 0.02; // sehr sanftes Fade
    if (gainNode) gainNode.gain.value = currentVolume;

    currentPitch += ((idlePitch + tachoValue * (maxPitch - idlePitch)) - currentPitch) * 0.05;
    if (bufferSource) bufferSource.playbackRate.value = currentPitch;

    // --- Pops ---
    if (lastGasValue > 0.01 && gasValue <= 0.01) gasJustReleased = true;
    if (gasJustReleased) {
        gasJustReleased = false;
        const popCount = 3 + Math.floor(Math.random() * 4);
        for (let i = 0; i < popCount; i++) {
            setTimeout(() => playPop(tachoValue, Math.random() > 0.5),
                i * (100 + Math.random() * 150)
            );
        }
        for (let i = 0; i < 2; i++) {
            setTimeout(() => playPop(tachoValue, Math.random() > 0.5),
                popCount * 150 + Math.random() * 300
            );
        }
    }

    lastGasValue = gasValue;
    requestAnimationFrame(animate);
}
</script>
</body>
        </html>
            
