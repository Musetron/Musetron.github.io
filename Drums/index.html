<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Luft Schlagzeug mit PSMove</title>
<style>
body { margin:0; background:#111; overflow:hidden; }
canvas { display:block; touch-action:none; }
</style>
</head>
<body>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const video = document.createElement("video");

video.autoplay = true;
video.playsInline = true;

// Tracker für 2 Controller
const maxTrackers = 2;
let trackerIndex = 0;
let trackers = [
  {color:null, drawColor:"red", punch:false},
  {color:null, drawColor:"cyan", punch:false}
];
let history = [[],[]];
const historyLength = 5;
const speedThreshold = 40; // PSMove schneller Bewegungen
const cooldownFrames = 12;
let cooldowns = [0,0];

// Felder
let fields = [
  {x:0.1, y:0.2, w:0.35, h:0.25, sound:'crash.wav'}, 
  {x:0.55,y:0.2,w:0.35,h:0.25,sound:'hat.wav'},      
  {x:0.1, y:0.6, w:0.25, h:0.35,sound:'kick.wav'},  
  {x:0.375,y:0.6,w:0.25,h:0.35,sound:'snare.wav'},  
  {x:0.65,y:0.6,w:0.25,h:0.35,sound:'tom.wav'}      
];

// Sounds laden
let audioElements = {};
fields.forEach(f=>{
  const a = new Audio(f.sound);
  audioElements[f.sound]=a;
  a.load();
});

// Frontkamera starten
navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}})
  .then(stream=>video.srcObject=stream);

// Wähle Tracker per Klick
canvas.addEventListener("pointerdown", e=>{
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor((e.clientX - rect.left) * canvas.width / rect.width);
  const y = Math.floor((e.clientY - rect.top) * canvas.height / rect.height);
  const pixel = ctx.getImageData(x,y,1,1).data;
  trackers[trackerIndex].color = {r:pixel[0],g:pixel[1],b:pixel[2]};
  history[trackerIndex] = [];
  cooldowns[trackerIndex] = 0;
  trackerIndex = (trackerIndex+1)%maxTrackers;
});

// PSMove Tracking Loop
function loop(){
  if(video.videoWidth===0){
    requestAnimationFrame(loop);
    return;
  }

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  // Spiegelung
  ctx.save();
  ctx.translate(canvas.width,0);
  ctx.scale(-1,1);
  ctx.drawImage(video,0,0);
  ctx.restore();

  // Felder zeichnen
  fields.forEach(f=>{
    ctx.strokeStyle='white';
    ctx.lineWidth=3;
    ctx.strokeRect(f.x*canvas.width,f.y*canvas.height,f.w*canvas.width,f.h*canvas.height);
  });

  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = img.data;

  trackers.forEach((tracker,index)=>{
    if(!tracker.color) return;

    let sumX=0,sumY=0,count=0;

    // PSMove LEDs sind sehr hell → wir können einfache Thresholds nehmen
    for(let i=0;i<data.length;i+=4){
      const r=data[i],g=data[i+1],b=data[i+2];

      // Helligkeit statt Farbvergleich, LEDs sind leuchtend
      const brightness = 0.299*r + 0.587*g + 0.114*b;
      if(brightness>150){ // nur helle Punkte
        const px = (i/4)%canvas.width;
        const py = Math.floor((i/4)/canvas.width);
        sumX += px;
        sumY += py;
        count++;
      }
    }

    if(count>20){ // kleiner Bereich reicht bei LEDs
      let cx = sumX/count;
      let cy = sumY/count;

      // Glätten
      history[index].push({x:cx,y:cy});
      if(history[index].length>historyLength) history[index].shift();
      let smoothX = history[index].reduce((a,b)=>a+b.x,0)/history[index].length;
      let smoothY = history[index].reduce((a,b)=>a+b.y,0)/history[index].length;

      // Punch Detection
      tracker.punch=false;
      if(history[index].length>=2 && cooldowns[index]===0){
        let dx = history[index][history[index].length-1].x - history[index][history[index].length-2].x;
        let dy = history[index][history[index].length-1].y - history[index][history[index].length-2].y;
        const speed = Math.sqrt(dx*dx + dy*dy);
        if(speed>speedThreshold){
          tracker.punch=true;
          cooldowns[index]=cooldownFrames;

          // Feld Treffer
          fields.forEach(f=>{
            const fx = f.x*canvas.width, fy = f.y*canvas.height;
            const fw = f.w*canvas.width, fh = f.h*canvas.height;
            if(smoothX>=fx && smoothX<=fx+fw && smoothY>=fy && smoothY<=fy+fh){
              audioElements[f.sound].currentTime=0;
              audioElements[f.sound].play();
            }
          });
        }
      } else if(cooldowns[index]>0){
        cooldowns[index]--;
      }

      // Tracker zeichnen
      ctx.strokeStyle=tracker.punch?"yellow":tracker.drawColor;
      ctx.lineWidth=4;
      ctx.beginPath();
      ctx.arc(smoothX,smoothY,30,0,Math.PI*2);
      ctx.stroke();
    }
  });

  requestAnimationFrame(loop);
}

video.onplay = loop;
</script>

</body>
</html>
